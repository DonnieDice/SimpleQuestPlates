name: Release

on:
  push:
    tags:
      - 'v*'
      - '!v*-alpha*'
      - '!v*-beta*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    env:
      CF_API_KEY: ${{ secrets.CF_API_KEY }}
      WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
      WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
      GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
    - name: Clone project
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Environment
      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      
    - name: Create Changelog
      id: changelog
      uses: loopwerk/tag-changelog@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Package and Release
      uses: BigWigsMods/packager@v2
      with:
        args: -S -u
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Simple Quest Plates ${{ env.RELEASE_VERSION }}
        body: |
          # Simple Quest Plates ${{ env.RELEASE_VERSION }}
          
          ${{ steps.changelog.outputs.changes }}
          
          ## Installation
          
          ### CurseForge
          Install via CurseForge client or download from [CurseForge](https://www.curseforge.com/wow/addons/simple-quest-plates)
          
          ### WoWInterface
          Download from [WoWInterface](https://www.wowinterface.com/downloads/info1319776-SimpleQuestPlates.html)
          
          ### Manual Installation
          1. Download SimpleQuestPlates.zip from the assets below
          2. Extract to: `World of Warcraft\_retail_\Interface\AddOns\`
          3. Restart World of Warcraft
          
          ## Support
          
          - Discord: [discord.gg/N7kdKAHVVF](https://discord.gg/N7kdKAHVVF)
          - Issues: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
        files: |
          .release/*.zip
        fail_on_unmatched_files: false