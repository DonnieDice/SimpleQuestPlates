name: Package and Release

on:
  push:
    tags:
      - 'v*'  # Triggers only on version tags like v1.0.0, v1.0.0-alpha, etc.

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}

  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: Set Release Type
        id: set_release_type
        run: |
          TAG_NAME=${{ github.ref }}
          if [[ "$TAG_NAME" == *"beta"* ]]; then
            echo "release_type=beta" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" == *"alpha"* ]]; then
            echo "release_type=alpha" >> $GITHUB_OUTPUT
          else
            echo "release_type=release" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version from TOC
        id: extract_version
        run: |
          # Try to get version from TOC file, fallback to tag name
          if [ -f "SimpleQuestPlates.toc" ]; then
            version=$(grep -E "^## Version:" SimpleQuestPlates.toc | awk '{print $3}')
            if [ -z "$version" ]; then
              version="${{ github.ref_name }}"
            fi
          else
            version="${{ github.ref_name }}"
          fi
          echo "Extracted version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Extract Changelog
        id: extract_changelog
        run: |
          if [ -f "docs/CHANGELOG.md" ]; then
            # Read the changelog and properly escape it for JSON
            CHANGELOG=$(cat docs/CHANGELOG.md | head -20 | jq -Rs .)
            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          else
            echo "changelog=\"No changelog available\"" >> $GITHUB_OUTPUT
          fi

      - name: Package and Release
        uses: BigWigsMods/packager@master
        with:
          release-type: ${{ steps.set_release_type.outputs.release_type }}

      - name: Send Discord Notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi
          
          # Determine release type emoji and color
          RELEASE_TYPE="${{ steps.set_release_type.outputs.release_type }}"
          if [ "$RELEASE_TYPE" = "alpha" ]; then
            EMOJI="üî¨"
            TYPE_TEXT=" Alpha"
            COLOR=16711680
          elif [ "$RELEASE_TYPE" = "beta" ]; then
            EMOJI="üß™"
            TYPE_TEXT=" Beta"
            COLOR=16744448
          else
            EMOJI="üéØ"
            TYPE_TEXT=""
            COLOR=5820057
          fi
          
          # Get version - use tag name as fallback
          VERSION="${{ steps.extract_version.outputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.ref_name }}"
          fi
          
          # Get the changelog (already JSON-escaped from previous step)
          CHANGELOG='${{ steps.extract_changelog.outputs.changelog }}'
          
          # Build the JSON payload using jq for proper escaping
          JSON_PAYLOAD=$(jq -n \
            --arg emoji "$EMOJI" \
            --arg type_text "$TYPE_TEXT" \
            --arg version "$VERSION" \
            --arg tag "${{ github.ref_name }}" \
            --argjson changelog "$CHANGELOG" \
            --argjson color "$COLOR" \
            '{
              "content": "",
              "username": "SQP Release",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/logo.png",
              "embeds": [{
                "title": "\($emoji) SQP | Simple Quest Plates - \($version)\($type_text)",
                "description": "**See quest progress at a glance!** A new version of SQP has been released!\n\nüìù **What'\''s New:**\n\($changelog)\n\n**Display quest objective progress directly on enemy nameplates!**",
                "url": "https://github.com/donniedice/SimpleQuestPlates/releases/tag/\($tag)",
                "color": $color,
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/logo.png"
                },
                "fields": [
                  {
                    "name": "üì• Downloads",
                    "value": "[CurseForge](https://www.curseforge.com/wow/addons/simple-quest-plates)\n[WoWInterface](https://www.wowinterface.com/downloads/info26957)\n[GitHub](https://github.com/donniedice/SimpleQuestPlates)",
                    "inline": true
                  },
                  {
                    "name": "üéÆ Compatibility",
                    "value": "‚úÖ Midnight\n‚úÖ Classic Era\n‚úÖ TBC Anniversary\n‚úÖ MoP Classic",
                    "inline": true
                  },
                  {
                    "name": "üí¨ Support",
                    "value": "[Join Discord](https://discord.gg/N7kdKAHVVF)\n[Report Issues](https://github.com/donniedice/SimpleQuestPlates/issues)",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - RealmGX Community",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }')
          
          echo "Sending Discord notification..."
          echo "Version: $VERSION"
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"

      - name: Send Discord Failure Notification
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Discord webhook not configured, skipping notification"
            exit 0
          fi
          
          VERSION="${{ steps.extract_version.outputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="Unknown"
          fi
          
          JSON_PAYLOAD=$(jq -n \
            --arg version "$VERSION" \
            --arg run_id "${{ github.run_id }}" \
            '{
              "content": "",
              "username": "SQP Build Failed",
              "avatar_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/logo.png",
              "embeds": [{
                "title": "‚ùå SQP Build Failed",
                "description": "The release workflow encountered an error",
                "url": "https://github.com/donniedice/SimpleQuestPlates/actions/runs/\($run_id)",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Version",
                    "value": $version,
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": "[View Logs](https://github.com/donniedice/SimpleQuestPlates/actions/runs/\($run_id))",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - Build System",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }')
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"
