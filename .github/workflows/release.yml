name: Package and Release

on:
  push:
    tags:
      - 'v*'  # Triggers only on version tags like v1.0.0, v1.0.0-alpha, etc.

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: Set Release Type
        id: set_release_type
        run: |
          TAG_NAME=${{ github.ref }}
          if [[ "$TAG_NAME" == *"beta"* ]]; then
            echo "release_type=beta" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" == *"alpha"* ]]; then
            echo "release_type=alpha" >> $GITHUB_OUTPUT
          else
            echo "release_type=release" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version from TOC
        id: extract_version
        run: |
          version=$(grep -oP '^## Version: \K(.*)' ./SimpleQuestPlates.toc | head -1)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Package and Release
        uses: BigWigsMods/packager@master
        with:
          release-type: ${{ steps.set_release_type.outputs.release_type }}

      - name: Generate Changelog from Commits
        id: extract_changelog
        run: |
          # Get the previous tag, falling back to the first commit if no previous tag is found
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags `git rev-list --tags --skip=1  --max-count=1` 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          # Generate a changelog from commits between the previous tag and the current one (HEAD)
          # Format: ‚Ä¢ Commit message (short hash)
          CHANGELOG=$(git log --pretty=format:"‚Ä¢ %s (%h)" $PREVIOUS_TAG..HEAD)
          
          # Escape for JSON
          CHANGELOG="${CHANGELOG//$'
'/\n}"
          CHANGELOG="${CHANGELOG//\"/\\"}"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Simple Quest Plates v${{ steps.extract_version.outputs.version }}
          body: |
            # Simple Quest Plates v${{ steps.extract_version.outputs.version }}
            
            ${{ steps.extract_changelog.outputs.changelog }}
            
            ---
            
            ## Download Links
            - [CurseForge](https://www.curseforge.com/wow/addons/simple-quest-plates)
            - [Wago.io](https://addons.wago.io/addons/simple-quest-plates)
            - [WoWInterface](https://www.wowinterface.com/downloads/info26957)
            
            ## Support
            - [Discord](https://discord.gg/N7kdKAHVVF)
            - [GitHub Issues](https://github.com/donniedice/SimpleQuestPlates/issues)
          draft: false
          prerelease: ${{ steps.set_release_type.outputs.release_type != 'release' }}
          files: |
            .release/*.zip

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Get version
          VERSION="${{ steps.extract_version.outputs.version }}"
          
          # Extract changelog content from docs/CHANGES.md
          CHANGELOG_CONTENT=$(awk -v version="$VERSION" '
            BEGIN { found = 0; content = ""; first = 1 }
            /^## Version/ {
              split($0, parts, " ")
              if (parts[3] == version) {
                found = 1
                next
              } else if (found) {
                exit
              }
            }
            found && /^---/ { exit }
            found && /^<p align="center">/ { exit }
            found {
              # Skip empty lines at the beginning
              if (NF == 0 && first) next
              first = 0
              
              # Format for Discord
              if ($0 ~ /^###/) {
                gsub(/^### /, "**", $0)
                content = content $0 "**\\n"
              } else if ($0 ~ /^- /) {
                gsub(/^- /, "‚Ä¢ ", $0)
                content = content $0 "\\n"
              } else if (NF > 0) {
                content = content $0 "\\n"
              }
            }
            END {
              # Remove trailing newlines
              gsub(/\\n+$/, "", content)
              print content 
            }
          ' docs/CHANGES.md)
          
          # Limit changelog and add ellipsis if truncated
          if [ ${#CHANGELOG_CONTENT} -gt 800 ]; then
            CHANGELOG_CONTENT="${CHANGELOG_CONTENT:0:800}..."
          fi
          
          # Escape quotes for JSON
          CHANGELOG_CONTENT="${CHANGELOG_CONTENT//\"/\\"}"
          
          # If changelog is empty, provide default
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Check the release notes for details about this update!"
          fi
          
          # Send Discord webhook
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"\",
                 \"username\": \"SQP Updates\",
                 \"avatar_url\": \"https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/logo.png\",
                 \"embeds\": [{
                   \"title\": \"üéØ Simple Quest Plates v${VERSION} Released!\",
                   \"description\": \"**See quest progress at a glance on enemy nameplates!**\\n\\nA new version of Simple Quest Plates has been released!\\n\\n**üìù What's New:**\\n${CHANGELOG_CONTENT}\",
                   \"url\": \"https://github.com/donniedice/SimpleQuestPlates/releases/tag/v${VERSION}\",
                   \"color\": 5820057,
                   \"thumbnail\": {
                     \"url\": \"https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/logo.png\"
                   },
                   \"fields\": [
                     {
                       \"name\": \"üì• Downloads\",
                       \"value\": \"[CurseForge](https://www.curseforge.com/wow/addons/simple-quest-plates)\\n[Wago.io](https://addons.wago.io/addons/simple-quest-plates)\\n[WoWInterface](https://www.wowinterface.com/downloads/info26957)\\n[GitHub](https://github.com/donniedice/SimpleQuestPlates)\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üéÆ Compatibility\",
                       \"value\": \"‚úÖ The War Within\\n‚úÖ Classic Era\\n‚úÖ Cataclysm\\n‚úÖ MoP Classic\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"üí¨ Support\",
                       \"value\": \"[Join Discord](https://discord.gg/N7kdKAHVVF)\\n[Report Issues](https://github.com/donniedice/SimpleQuestPlates/issues)\",
                       \"inline\": true
                     }
                   ],
                   \"footer\": {
                     \"text\": \"RGX Mods - RealmGX Community | Made with ‚ù§Ô∏è by DonnieDice\",
                     \"icon_url\": \"https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif\"
                   },
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\" 
                 }]
               }" 
               "$DISCORD_WEBHOOK"
